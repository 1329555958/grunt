/*! finlog - v0.1.0 - 2015-11-10 Copyright (c) 2015 vfinance; Licensed MIT */
require("./app").register.controller("logqryTabController",function($scope,$myhttp,$timeout){function reset(){$scope.condition={},$scope.addedConds=[],$scope.hasCond=!0}function saveConfigData(data){data&&_.extend(configData,data),configData.id&&$scope.$emit("ToSaveConfig",configData)}function replaceHighlightField(data){var hits=data&&data.hits;if(hits)return _.each(hits,function(h){h.highlight&&(_.each(h.highlight,function(val,key){h[key]&&(h[key]=val[0]),h._source[key]&&(h._source[key]=val[0])}),delete h.highlight)}),data}function getSourceData(rcd){var result=[];return _.each(rcd,function(val,key){result.push('<span class="field-key">'+key+":</span>"+JSON.stringify(val).replace(/\\"/g,""))}),result.join(" ")}function dealTimeRange(data){timeRange=_.chain(data).pick("startTime","endTime").each(function(val,key,t){t[key]=dateUtil.parse(val).getTime()}).value(),console.log("timerange",timeRange)}var TabId=null;$(".tab-pane>.ng-scope").each(function(){var s=angular.element(this).scope();s.$id===$scope.$id&&(TabId=$(this).parent(".tab-pane").attr("id"))});var loadCfgDef=$.Deferred(),timeRangeDef=$.Deferred(),fieldData={},configData={id:"",condition:{},showFields:[]};$scope.maxLengthField="",$scope.fieldSet=[],$scope.hits={hits:[]};var def_show_field=["_source"],allFields=[];reset();var timeRange={},eventName="OnReceive"+TabId;$scope.$on(eventName,function(event,data){configData.id||(_.extend(configData,data),$scope.condition=configData.condition||{},$scope.addedConds=_.keys($scope.condition),configData.sort&&configData.sort.field||(configData.sort={field:"@timestamp",type:"desc"}),$scope.sort=configData.sort),loadCfgDef.resolve()}),$scope.$emit("ConsumeAConfig",{tabId:TabId,eventName:eventName});var IsShownTab=$("#"+TabId).hasClass("active");$scope.$on(EVENT.TAB_SHOWN.broadcast,function(event,data){data.target.target==="#"+TabId?(IsShownTab=!0,$scope.search()):IsShownTab=!1}),$.when($myhttp.get("/es/fields/logstash-*",function(data){fieldData=data,$scope.fieldSet=_.chain(data).pick(function(p){return"string"===p.type}).keys().value(),allFields=_.keys(data),$scope.addCondition(),configData.allFields=$scope.fieldSet,$scope.maxLengthField=_.max($scope.fieldSet,function(f){return f.length})+"NN"})),$scope.addCondition=function(){var reminder_conds=$scope.getReminderFields();$scope.hasCond&&$scope.addedConds.push(reminder_conds[0])},$scope.removeCond=function(index){$scope.addedConds.splice(index,1)},$scope.getReminderFields=function(field){var fields=[];field&&fields.push(field);var reminder_conds=_.difference($scope.fieldSet,$scope.addedConds);return $scope.hasCond=!!reminder_conds.length,fields.concat(reminder_conds)},$scope.search=function(append,size){if(IsShownTab){append=void 0===append?!1:append;var fields={};_.each($scope.addedConds,function(f){fields[f]={a:1}});var param={body:{highlight:{require_field_match:"true",pre_tags:["<mark>"],post_tags:["</mark>"],fields:fields}},size:angular.isNumber(size)?size:10},condition=configData.condition;append?param.from=$scope.hits.hits.length:(condition=_.pick($scope.condition,$scope.addedConds),saveConfigData({condition:condition,sort:$scope.sort})),param.condition=condition,_.extend(param,timeRange),param.sort=$scope.sort.field+":"+$scope.sort.type,$scope.searching=!0,$myhttp("searching",$scope).get("/logQry/qry",param,function(data){append?$scope.hits.hits=$scope.hits.hits.concat(replaceHighlightField(data).hits):$scope.hits=replaceHighlightField(data)})}},$scope.changeSort=function(field){_.contains(allFields,field)&&($scope.sort.field===field?$scope.sort.type="desc"===$scope.sort.type?"asc":"desc":($scope.sort.field=field,$scope.sort.type="desc"),$scope.search(!1,_.get($scope,"hits.hits.length",10)))},$scope.getSortClass=function(field){return _.contains(allFields,field)?$scope.sort.field===field?"sorting_"+$scope.sort.type:"sorting":""},$scope.reset=function(){reset(),$scope.addCondition()};var delaySearchQueue=[];$scope.delaySearch=function(){for(var i=0;i<delaySearchQueue.length;i++)$timeout.cancel(delaySearchQueue.shift());delaySearchQueue.push($timeout($scope.search,700))},$scope.getShowFields=function(){return configData.showFields.length?configData.showFields:def_show_field},$scope.getHidenFields=function(){return _.difference(allFields,configData.showFields)},$scope.addShowField=function(field){configData.showFields.push(field),saveConfigData()},$scope.removeShowField=function(field){var index=_.indexOf(configData.showFields,field);-1!==index&&(configData.showFields.splice(index,1),saveConfigData())},$scope.getFieldData=function(field,rcd){return"_source"===field?getSourceData(rcd):rcd._source[field]},$scope.aceJson=function(obj){return JSON.stringify(obj,function(key,value){return value},"	")},$scope.showRecordDetail={},$scope.$on(EVENT.CONDITION_CHANGE.broadcast,function(event,data){dealTimeRange(data),"pending"!==timeRangeDef.state()&&$scope.search()}),$scope.$on(TabId,function(event,data){dealTimeRange(data),timeRangeDef.resolve()}),$scope.$emit(EVENT.CHANGE_CONDITION.emit,TabId),$.when(loadCfgDef,timeRangeDef).then($scope.search)}),require("./app").register.controller("logqryController",function($scope,$rootScope,$myhttp,$http){function saveConfig(data){var old=_.find($scope.tabConfig.tabs,function(t){return t.id===data.id});old&&(_.extend(old,data),_.each(old,function(val,key){_.startsWith(key,"$$")&&delete old[key]}),$myhttp.post("/es/update/finlog/logqry/"+old.id,JSON.stringify(old),function(data){console.log("save success!",data)}))}function loadConfig(){$myhttp.get("/logQry/loadQry",function(data){$scope.tabConfig.tabs=[],_.each(data,function(cfg){$scope.tabConfig.addTab(cfg,!0)})})}function saveCallback(tab){saveConfig(tab)}function addCallback(tab){UnbindTabIds.push(tab.id),saveConfig(tab)}function closeCallback(tab){_.remove($scope.tabConfig.tabs,function(t){return t.id===tab.id})}function delCallback(tab){$myhttp.post("/logQry/delQry",JSON.stringify({id:tab.id}),function(data){console.log("删除查询",tab,data)})}$scope.tabPage="/public/views/logqry_sub.html",$scope.tabConfig={newTabName:"新建查询",tabs:[],templateUrl:$scope.tabPage,saveCallback:saveCallback,addCallback:addCallback,closeCallback:closeCallback,delCallback:delCallback};var UnbindTabIds=[];$scope.$on("ToSaveConfig",function(event,data){saveConfig(data)}),$scope.$on("ConsumeAConfig",function(event,data){var tabid=data.tabId,cfg=null;tabid&&_.remove(UnbindTabIds,function(id){return id===tabid}).length&&(cfg=_.find($scope.tabConfig.tabs,function(t){return t.id===tabid}),cfg=cfg?_.omit(cfg,"name","oldName"):null),$scope.$broadcast(data.eventName,cfg)}),loadConfig()});