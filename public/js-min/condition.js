/*! finlog - v0.1.0 - 2015-11-10 Copyright (c) 2015 vfinance; Licensed MIT */
define("condition",function(){return function($scope){function getSelTime(){return dateUtil.parse($scope.customTimeSlot.startTime+" "+$scope.customTimeSlot.hour+":00")}function resetHours(){$scope.customTimeSlot.startTime>=dateUtil.format(new Date,"yyyy-MM-dd")?($scope.sliderOpts.min=0,$scope.sliderOpts.value=$scope.sliderOpts.min,$scope.customTimeSlot.hour=$scope.sliderOpts.value,$scope.sliderOpts.max=dateUtil.format(new Date,"hh")-0,$scope.sliderRefresh=!$scope.sliderRefresh):$scope.customTimeSlot.startTime===dateUtil.format($scope.calendarCfg.startDate,"yyyy-MM-dd")?($scope.sliderOpts.max=23,$scope.sliderOpts.min=dateUtil.format(new Date,"hh")-0,$scope.sliderOpts.value=$scope.sliderOpts.min,$scope.customTimeSlot.hour=$scope.sliderOpts.value,$scope.sliderRefresh=!$scope.sliderRefresh):23!==$scope.sliderOpts.max&&($scope.sliderOpts.min=0,$scope.sliderOpts.max=23,$scope.sliderOpts.value=$scope.customTimeSlot.hour-0,$scope.sliderRefresh=!$scope.sliderRefresh)}function reShowSlots(){var selTime=getSelTime(),endTime=new Date,index=_.findIndex($scope.timeSlots,function(slot){return calcTime(slot,selTime)>endTime});$scope.slotThreshold=-1===index?$scope.timeSlots.length:index,index=_.findIndex($scope.timeSlots,function(t){return t.value+":"+t.unit===$scope.customTimeSlot.slot}),index>=$scope.slotThreshold&&($scope.customTimeSlot.slot="30:MIN")}function calcTime(timeSlot,startTime){var endTime=new Date,calc=-1;switch(startTime&&(endTime=startTime,calc=1),timeSlot.unit){case"MIN":return dateUtil.addInteger(endTime,dateUtil.calendar.minute,(timeSlot.value-0)*calc);case"HOUR":return dateUtil.addInteger(endTime,dateUtil.calendar.hour,(timeSlot.value-0)*calc);case"DAY":return dateUtil.addInteger(endTime,dateUtil.calendar.day,(timeSlot.value-0)*calc)}}function extendCondition(data){data&&_.each(_condition_keys,function(key){data.hasOwnProperty(key)&&(condition[key]=data[key])})}function changeCondition(data){if(data&&(extendCondition(data),angular.isString(data.timeSlot))){var timeSlot=_.find($scope.timeSlots,function(t){return t.display===data.timeSlot});if(timeSlot)return void $scope.changeTimeSlot(timeSlot)}$.extend(event_condition,condition),$scope.$emit(EVENT.CONDITION_CHANGE.emit,event_condition),angular.store(STORE.CONDITION,condition)}function changeConDisplay(data){$.extend($scope.condition_display,data),angular.store(STORE.CONDITION_DISPLAY,$scope.condition_display)}$scope.timeSlots=[{value:"30",display:"30分钟",unit:"MIN",tickInter:5,dateFormat:"hh:mm"},{value:"60",display:"60分钟",unit:"MIN",tickInter:10,dateFormat:"hh:mm"},{value:"3",display:"3小时",unit:"HOUR",tickInter:30,dateFormat:"hh:mm"},{value:"6",display:"6小时",unit:"HOUR",tickInter:30,dateFormat:"hh:mm"},{value:"12",display:"12小时",unit:"HOUR",tickInter:24,dateFormat:"hh:mm"},{value:"24",display:"24小时",unit:"HOUR",tickInter:24,dateFormat:"hh:mm"},{value:"3",display:"3天",unit:"DAY",tickInter:24,dateFormat:"MM月dd日 hh:mm"},{value:"7",display:"7天",unit:"DAY",tickInter:24,dateFormat:"MM月dd日 hh:mm"}],$scope.sliderOpts={min:dateUtil.format(new Date,"hh")-0,max:23,value:dateUtil.format(new Date,"hh")-0,step:1},$scope.sliderRefresh=!1,$scope.customTimeSlot={startTime:"",hour:$scope.sliderOpts.value,slot:"30:MIN",endTime:""};var curDate=new Date;$scope.calendarCfg={startDate:dateUtil.addInteger(curDate,dateUtil.calendar.day,-7),endDate:curDate},$scope.$watch("customTimeSlot.startTime",function(value){resetHours(),reShowSlots(),$scope.onTimeSlotChange()}),$scope.$watch("customTimeSlot.hour",function(value){reShowSlots(),$scope.onTimeSlotChange()}),$scope.onTimeSlotChange=function(){var slot=_.find($scope.timeSlots,function(t){return t.value+":"+t.unit===$scope.customTimeSlot.slot});slot&&($scope.customTimeSlot.endTime=dateUtil.format(calcTime(slot,getSelTime()),"yyyy-MM-dd hh:mm"))},$scope.slotThreshold=0,$scope.condition_display={timeSlot:"30分钟"},changeConDisplay(angular.store(STORE.CONDITION_DISPLAY)),$scope.show_condition_area=!0,$scope.$on(EVENT.CONDITION_AREA.broadcast,function(event,data){$scope.show_condition_area=!!data}),$scope.changeTimeSlot=function(timeSlot,start_time){$scope.customTimeSlotActive=!1;var endTime=null,startTime=null;start_time?(startTime=start_time,endTime=calcTime(timeSlot,startTime)):(endTime=new Date,startTime=calcTime(timeSlot)),changeCondition({unit:timeSlot.unit,timeSlot:timeSlot.value,endTime:dateUtil.format(endTime),startTime:dateUtil.format(startTime)});var time=null,display=null;start_time?display=dateUtil.format(dateUtil.parse(condition.startTime),"yyyy-MM-dd hh:mm")+" 至 "+dateUtil.format(dateUtil.parse(condition.endTime),"yyyy-MM-dd hh:mm"):(time=_.find($scope.timeSlots,function(c){return c.value===condition.timeSlot&&c.unit===condition.unit}),time&&(display=time.display)),changeConDisplay({timeSlot:display})},$scope.isActiveTimeSlot=function(slot){return!$scope.customTimeSlotActive&&slot.value===condition.timeSlot&&slot.unit===condition.unit},$scope.isActiveCustomSlot=function(){return $scope.customTimeSlotActive},$scope.customTimeSlotActive=!1,$scope.changeCustomTimeSlot=function(){var slot=_.find($scope.timeSlots,function(t){return t.value+":"+t.unit===$scope.customTimeSlot.slot}),start_time=getSelTime();$scope.changeTimeSlot(slot,start_time),$scope.customTimeSlotActive=!0};var condition={timeSlot:"30",unit:"MIN",endTime:dateUtil.format(new Date),startTime:dateUtil.format(dateUtil.addInteger(new Date,dateUtil.calendar.minute,-30))},_condition_keys=_.keys(condition);changeCondition(angular.store(STORE.CONDITION)),$scope.changeTimeSlot(_.find($scope.timeSlots,function(c){return c.value===condition.timeSlot&&c.unit===condition.unit})),$scope.$emit(EVENT.CONDITION_CHANGE.emit,condition),$scope.$on(EVENT.CHANGE_CONDITION.broadcast,function(event,data){changeCondition(data)});var event_condition={}}});